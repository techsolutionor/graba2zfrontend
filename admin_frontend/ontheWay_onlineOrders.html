<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>On the Way Orders</title>
    <link rel="shortcut icon" type="image/png" href="./assets/images/logos/favicon.png" />
    <link rel="stylesheet" href="./assets/css/styles.min.css" />
    <link rel="stylesheet" href="./assets/css/navbar.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./assets/css/order.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="./assets/libs/jquery/dist/jquery.min.js"></script>
    <script src="./assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/js/sidebarmenu.js"></script>
    <script src="./assets/js/app.min.js"></script>
    <script src="./assets/libs/simplebar/dist/simplebar.js"></script>
    <script src="./apiConfig/apiConfig.js"></script>
    <style>
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <div id="loader" class="loader-container" style="display: none;">
        <div class="loader"></div>
    </div>

    <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full" data-sidebar-position="fixed" data-header-position="fixed">
        <aside class="left-sidebar">
            <!-- Sidebar content: COPY FROM online-orders.html sidebar -->
        </aside>

        <div class="body-wrapper">
            <header class="app-header">
                <!-- Navbar: COPY FROM online-orders.html header -->
            </header>

            <div class="container-fluid">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title fw-semibold mb-4">Dashboard / On The Way Orders</h5>
                        <div class="container">
                            <div class="actions-bar d-flex flex-column flex-md-row align-items-center align-items-lg-end justify-content-center justify-content-md-center justify-content-lg-end">
                                <div class="d-flex justify-content-center mb-2 mb-md-0 me-md-2 w-100" style="max-width: 200px;">
                                    <label for="statusDropdown" class="me-2">Change Status:</label>
                                    <select id="statusDropdown" class="form-select">
                                        <option value="">-- Select Status --</option>
                                    </select>
                                </div>
                                <div class="d-flex justify-content-center mb-2 mb-md-0 me-md-2 w-100" style="max-width: 150px;">
                                    <button onclick="updateSelectedOrderStatus()" class="btn btn-success w-100">Update Status</button>
                                </div>
                            </div>

                            <div class="table-container mt-4">
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Order ID</th>
                                                <th>Customer Name</th>
                                                <th>Customer Contact</th>
                                                <th>Order Status</th>
                                                <th>Payment Type</th>
                                                <th>Order Date</th>
                                                <th>Total Amount</th>
                                                <th>Items</th>
                                                <th>Shipping Address</th>
                                            </tr>
                                        </thead>
                                        <tbody id="purchaseReturnsTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const allowedStatuses = [
            "Received Order", "Inprogress Order", "Ready for Shipment",
            "On the Way", "Delevered", "On Hold"
        ];

        const statusDropdown = document.getElementById("statusDropdown");

        allowedStatuses.forEach(status => {
            const opt = document.createElement("option");
            opt.value = status;
            opt.textContent = status;
            statusDropdown.appendChild(opt);
        });

        async function fetchOrders() {
            document.getElementById('loader').style.display = 'flex';
            try {
                const response = await fetch(`${API_ADMINGRAB_URL}/api/onlineorders/on-the-way`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json',
                    },
                });

                const orders = await response.json();
                const tbody = document.getElementById("purchaseReturnsTableBody");
                tbody.innerHTML = "";

                orders.forEach(order => {
                    const row = document.createElement("tr");

                    let customerContact = 'N/A';
                    try {
                        const info = JSON.parse(order.shippingInfo);
                        customerContact = info.contact || 'N/A';
                    } catch (e) { }

                    let itemsCount = 'N/A';
                    try {
                        const cardItems = JSON.parse(order.card_info);
                        itemsCount = cardItems.reduce((sum, item) => sum + (item.quantity || 0), 0);
                    } catch (e) { }

                    const orderDate = order.created_at
                        ? new Date(order.created_at).toLocaleString()
                        : 'N/A';

                    row.innerHTML = `
                        <td>${order.order_id}</td>
                        <td>${order.customer_name || 'N/A'}</td>
                        <td>${customerContact}</td>
                        <td>${order.order_status}</td>
                        <td>${order.payment_type}</td>
                        <td>${orderDate}</td>
                        <td>${order.total_amount}</td>
                        <td>${itemsCount}</td>
                        <td>${order.shipping_address || 'N/A'}</td>
                    `;

                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error("❌ Fetch error:", error);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function updateSelectedOrderStatus() {
            const newStatus = statusDropdown.value;
            if (!newStatus) {
                alert("Please select a status to update all 'On the Way' orders.");
                return;
            }

            const rejection_comment = newStatus === 'Rejected'
                ? prompt("Enter rejection comment:") || "Rejected without comment"
                : null;

            try {
                const res = await fetch(`${API_ADMINGRAB_URL}/api/onlineorders/update-on-the-way-status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        new_status: newStatus,
                        rejection_comment: rejection_comment
                    })
                });

                const result = await res.json();
                alert(result.message || "Status updated.");
                fetchOrders();

            } catch (err) {
                console.error("❌ Status update error:", err);
            }
        }

        fetchOrders();
    </script>
</body>

</html>
